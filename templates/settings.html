{% extends "base.html" %}
{% block content %}
  <div class="panel">
    <h2>Settings</h2>
    <div class="tabs">
      <button class="tab {% if active_tab != 'templates' %}active{% endif %}" type="button" data-tab="tab-settings-general">General</button>
      <button class="tab {% if active_tab == 'templates' %}active{% endif %}" type="button" data-tab="tab-settings-templates">Email Templates</button>
    </div>
  </div>

  <div class="panel tab-panel {% if active_tab != 'templates' %}active{% endif %}" id="tab-settings-general">
    <h2>SMTP Settings</h2>
    <form method="post" enctype="multipart/form-data">
      <input type="hidden" name="form_type" value="general" />
      <div class="row">
        <div>
          <label>SMTP Host</label>
          <input name="smtp_host" value="{{ settings['smtp_host'] }}" />
        </div>
        <div>
          <label>SMTP Port</label>
          <input name="smtp_port" value="{{ settings['smtp_port'] or '587' }}" />
        </div>
        <div>
          <label>SMTP Username</label>
          <input name="smtp_user" value="{{ settings['smtp_user'] }}" />
        </div>
        <div>
          <label>SMTP Password</label>
          <input name="smtp_pass" type="password" value="{{ settings['smtp_pass'] }}" />
        </div>
      </div>
      <div class="row">
        <div>
          <label>From Address</label>
          <input name="smtp_from" value="{{ settings['smtp_from'] }}" />
        </div>
        <div>
          <label>SMTP Timeout (seconds)</label>
          <input name="smtp_timeout" value="{{ settings['smtp_timeout'] or '20' }}" />
        </div>
        <div>
          <label>Use TLS</label>
          <input name="smtp_tls" type="checkbox" {% if settings['smtp_tls'] != 'false' %}checked{% endif %} />
        </div>
      </div>

      <h2>Scheduled Run Controls</h2>
      <div class="row">
        <div>
          <label>Send Delay (seconds)</label>
          <input name="scheduled_send_delay_seconds" value="{{ settings['scheduled_send_delay_seconds'] or '1' }}" />
        </div>
        <div>
          <label>Retries Per Recipient</label>
          <input name="scheduled_send_retries" value="{{ settings['scheduled_send_retries'] or '2' }}" />
        </div>
        <div>
          <label>Retry Backoff (seconds)</label>
          <input name="scheduled_retry_backoff_seconds" value="{{ settings['scheduled_retry_backoff_seconds'] or '3' }}" />
        </div>
        <div>
          <label>Max Recipients Per Run (0 = no limit)</label>
          <input name="scheduled_max_recipients" value="{{ settings['scheduled_max_recipients'] or '0' }}" />
        </div>
      </div>

      <h2>Company Info</h2>
      <div class="row">
        <div>
          <label>Company Name</label>
          <input name="company_name" value="{{ settings['company_name'] }}" />
        </div>
        <div>
          <label>Statement Subtitle</label>
          <input name="company_subtitle" value="{{ settings['company_subtitle'] }}" />
        </div>
        <div>
          <label>Address</label>
          <input name="company_address" value="{{ settings['company_address'] }}" />
        </div>
        <div>
          <label>Phone</label>
          <input name="company_phone" value="{{ settings['company_phone'] }}" />
        </div>
      </div>
      <div class="row">
        <div>
          <label>Company Email</label>
          <input name="company_email" value="{{ settings['company_email'] }}" />
        </div>
        <div>
          <label>Company Website</label>
          <input name="company_website" value="{{ settings['company_website'] }}" />
        </div>
        <div>
          <label>Upload Logo (optional)</label>
          <input name="logo_file" type="file" accept=".png,.jpg,.jpeg,.gif" />
          {% if settings['logo_path'] %}
            <small>Current: {{ settings['logo_path'].split('/')[-1].split('\\\\')[-1] }}</small>
          {% endif %}
        </div>
      </div>

      <h2>Notice CC Settings</h2>
      <div class="row">
        <div>
          <label>Statement CC</label>
          <input name="cc_statement" type="email" value="{{ settings['cc_statement'] }}" />
        </div>
        <div>
          <label>Overdue Notice CC</label>
          <input name="cc_overdue" type="email" value="{{ settings['cc_overdue'] }}" />
        </div>
        <div>
          <label>Skipped Notice CC</label>
          <input name="cc_skipped" type="email" value="{{ settings['cc_skipped'] }}" />
        </div>
        <div>
          <label>Short Paid Notice CC</label>
          <input name="cc_short_paid" type="email" value="{{ settings['cc_short_paid'] }}" />
        </div>
      </div>

      <h2>Invoice Source</h2>
      <div class="row">
        <div>
          <label>Source</label>
          <select name="invoice_source">
            <option value="latest_upload" {% if settings['invoice_source'] != 'path' %}selected{% endif %}>Latest Upload</option>
            <option value="path" {% if settings['invoice_source'] == 'path' %}selected{% endif %}>Fixed Path</option>
          </select>
        </div>
        <div>
          <label>Invoice Path (if fixed)</label>
          <input name="invoice_path" value="{{ settings['invoice_path'] }}" />
        </div>
      </div>

      <button type="submit">Save Settings</button>
    </form>
  </div>

  <div class="panel tab-panel {% if active_tab == 'templates' %}active{% endif %}" id="tab-settings-templates">
    <h2>Email Templates</h2>
    <p><small>You can edit email body text only. Subjects remain fixed (with date appended where applicable).</small></p>
    <form method="post">
      <input type="hidden" name="form_type" value="email_templates" />
      <div class="row">
        <div>
          <label>Statement Body</label>
          <textarea name="email_template_statement" rows="8">{{ email_templates['statement'] }}</textarea>
        </div>
      </div>
      <div class="row">
        <div>
          <label>Overdue Notice Body</label>
          <textarea name="email_template_overdue" rows="8">{{ email_templates['overdue'] }}</textarea>
        </div>
      </div>
      <div class="row">
        <div>
          <label>Follow Up Body</label>
          <textarea name="email_template_follow_up" rows="8">{{ email_templates['follow_up'] }}</textarea>
        </div>
      </div>
      <div class="row">
        <div>
          <label>Skipped Notice Body</label>
          <textarea name="email_template_skipped" rows="8">{{ email_templates['skipped'] }}</textarea>
        </div>
      </div>
      <div class="row">
        <div>
          <label>Short Paid Notice Body</label>
          <textarea name="email_template_short_paid" rows="8">{{ email_templates['short_paid'] }}</textarea>
        </div>
      </div>
      <button type="submit">Save Templates</button>
    </form>
  </div>

  <script>
    const tabs = document.querySelectorAll('.tab');
    const panels = document.querySelectorAll('.tab-panel');
    tabs.forEach((tab) => {
      tab.addEventListener('click', () => {
        tabs.forEach((btn) => btn.classList.remove('active'));
        panels.forEach((panel) => panel.classList.remove('active'));
        tab.classList.add('active');
        const target = document.getElementById(tab.dataset.tab);
        if (target) {
          target.classList.add('active');
        }
      });
    });
  </script>
{% endblock %}
