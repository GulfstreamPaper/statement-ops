{% extends "base.html" %}
{% block content %}
  <div class="panel">
    <h2>Edit Group</h2>
    <form method="post">
      <div class="row">
        <div>
          <label>Group Name</label>
          <input name="group_name" value="{{ recipient['group_name'] }}" required />
        </div>
        <div>
          <label>Emails (comma separated)</label>
          <input name="email_to" value="{{ recipient['email_to'] }}" required />
        </div>
        <div>
          <label>Terms</label>
          <select name="terms_code">
            {% for code, label in term_options %}
              <option value="{{ code }}" {% if code == recipient['terms_code'] %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label>Frequency</label>
          <select name="frequency">
            <option value="weekly" {% if recipient['frequency'] == 'weekly' %}selected{% endif %}>Weekly</option>
            <option value="biweekly" {% if recipient['frequency'] == 'biweekly' %}selected{% endif %}>Biweekly</option>
            <option value="monthly" {% if recipient['frequency'] == 'monthly' %}selected{% endif %}>Monthly</option>
            <option value="none" {% if recipient['frequency'] == 'none' %}selected{% endif %}>None</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div>
          <label>Day of Week</label>
          <select name="day_of_week">
            {% for idx, name in [(0,'Monday'),(1,'Tuesday'),(2,'Wednesday'),(3,'Thursday'),(4,'Friday'),(5,'Saturday'),(6,'Sunday')] %}
              <option value="{{ idx }}" {% if recipient['day_of_week'] == idx %}selected{% endif %}>{{ name }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label>Day of Month (for monthly)</label>
          <input name="day_of_month" type="number" min="1" max="28" value="{{ recipient['day_of_month'] or 1 }}" />
        </div>
        <div>
          <label>Active</label>
          <input name="active" type="checkbox" {% if recipient['active'] %}checked{% endif %} />
        </div>
        <div>
          <label>Members</label>
          <button type="button" class="secondary" id="openGroupMembers">Select Members</button>
        </div>
      </div>
      <div class="member-summary" id="groupMemberSummary">No members selected.</div>
      <div class="actions">
        <button type="submit">Save Group</button>
        <a class="button-link" href="{{ url_for('customers') }}">Back</a>
      </div>

      <div class="modal" id="groupMembersModal">
        <div class="modal-card">
          <h3>Select Group Members</h3>
          <div class="row">
            <div>
              <label>Search</label>
              <input id="groupMemberSearch" placeholder="Search customers" />
            </div>
          </div>
          <div class="member-list" id="groupMemberList">
            {% for customer in singles %}
              <label class="member-row" data-search="{{ customer['group_name'] | lower }}">
                <input type="checkbox" name="member_ids" value="{{ customer['id'] }}" {% if customer['id'] in member_ids %}checked{% endif %} />
                <span>{{ customer['group_name'] }}</span>
              </label>
            {% endfor %}
          </div>
          <div class="actions">
            <button type="button" class="secondary" id="closeGroupMembers">Done</button>
          </div>
        </div>
      </div>
    </form>
  </div>

  <script>
    const groupModal = document.getElementById('groupMembersModal');
    const openGroupMembers = document.getElementById('openGroupMembers');
    const closeGroupMembers = document.getElementById('closeGroupMembers');
    const groupMemberSearch = document.getElementById('groupMemberSearch');
    const groupMemberRows = document.querySelectorAll('#groupMemberList .member-row');
    const groupMemberSummary = document.getElementById('groupMemberSummary');

    function updateGroupSummary() {
      const selected = [];
      groupMemberRows.forEach((row) => {
        const checkbox = row.querySelector('input[type="checkbox"]');
        if (checkbox && checkbox.checked) {
          selected.push(row.textContent.trim());
        }
      });
      groupMemberSummary.textContent = selected.length ? selected.join(', ') : 'No members selected.';
    }

    if (openGroupMembers) {
      openGroupMembers.addEventListener('click', () => {
        groupModal.classList.add('active');
      });
    }
    if (closeGroupMembers) {
      closeGroupMembers.addEventListener('click', () => {
        groupModal.classList.remove('active');
        updateGroupSummary();
      });
    }
    if (groupMemberSearch) {
      groupMemberSearch.addEventListener('input', () => {
        const query = (groupMemberSearch.value || '').toLowerCase();
        groupMemberRows.forEach((row) => {
          row.style.display = row.dataset.search.includes(query) ? 'flex' : 'none';
        });
      });
    }
    groupMemberRows.forEach((row) => {
      const checkbox = row.querySelector('input[type="checkbox"]');
      if (checkbox) {
        checkbox.addEventListener('change', updateGroupSummary);
      }
    });
    updateGroupSummary();
  </script>
{% endblock %}
