{% extends "base.html" %}
{% block content %}
  <div class="panel">
    <h2>Overdue Report</h2>
    <div class="row">
      <div>
        <p><small>Source file: {{ invoice_label or 'No invoice file found' }}</small></p>
        {% if run %}
          <p><small>Last run: {{ run['created_at'] }} ({{ run['status'] }})</small></p>
        {% else %}
          <p><small>No report run yet.</small></p>
        {% endif %}
      </div>
      <div>
        <form method="post" action="{{ url_for('overdue_report_run') }}">
          <button type="submit" class="secondary">Run Report Now</button>
        </form>
        <p style="margin-top: 8px;">
          <a class="button-link export" href="{{ url_for('overdue_report_export') }}">Export to Excel</a>
        </p>
      </div>
    </div>
    <div class="row">
      <div>
        <label>Search</label>
        <input id="overdueSearch" placeholder="Search group name" />
      </div>
      <div>
        <label>Terms</label>
        <select id="overdueTerms">
          <option value="">All</option>
          {% for code, label in term_labels.items() %}
            <option value="{{ code }}">{{ label }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
    <table class="table">
      <thead>
        <tr>
          <th class="sortable" data-sort-key="group_name">Group</th>
          <th class="sortable" data-sort-key="terms">Terms</th>
          <th class="sortable" data-sort-key="overdue_count">Overdue Invoices</th>
          <th class="sortable" data-sort-key="days_overdue">Oldest Overdue (days)</th>
          <th class="sortable" data-sort-key="overdue_amount">Overdue Amount</th>
          <th class="sortable" data-sort-key="short_paid_count">Short Paid</th>
          <th class="sortable" data-sort-key="short_paid_amount">Short Paid Amount</th>
          <th class="sortable" data-sort-key="skipped_count">Skipped</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for row in rows %}
          <tr data-search="{{ row['group_name'] | lower }}" data-terms="{{ row['terms_code'] }}">
            <td>{{ row['group_name'] }}</td>
            <td>{{ term_labels.get(row['terms_code'], row['terms_code']) }}</td>
            <td>{{ row['overdue_count'] }}</td>
            <td>{{ row['days_overdue'] }}</td>
            <td>${{ "{:,.2f}".format(row['overdue_amount']) }}</td>
            <td>{{ row['short_paid_count'] or 0 }}</td>
            <td>${{ "{:,.2f}".format(row['short_paid_amount'] or 0) }}</td>
            <td>{{ row['skipped_count'] }}</td>
            <td class="actions">
              {% if row['recipient_id'] %}
                <a class="button-link" target="_blank" rel="noopener" href="{{ url_for('download_statement', recipient_id=row['recipient_id']) }}">Download</a>
                {% if row['overdue_count'] > 0 %}
                  <form method="post" action="{{ url_for('overdue_report_send', recipient_id=row['recipient_id']) }}" class="overdue-form" data-recipient-id="{{ row['recipient_id'] }}" data-has-email="{{ '1' if row['has_email'] else '0' }}" data-group-name="{{ row['group_name'] }}">
                    <input type="hidden" name="run_id" value="{{ run['id'] if run else '' }}" />
                    <input type="hidden" name="email_to" class="email-override-input" value="" />
                    <button type="submit" class="warning {% if row['sent_overdue'] %}sent{% endif %}">Overdue</button>
                  </form>
                {% endif %}
                {% if row['skipped_count'] > 0 %}
                  <button type="button" class="skipped skipped-btn {% if row['sent_skipped'] %}sent{% endif %}"
                          data-recipient-id="{{ row['recipient_id'] }}"
                          data-run-id="{{ run['id'] if run else '' }}"
                          data-has-email="{{ '1' if row['has_email'] else '0' }}"
                          data-group-name="{{ row['group_name'] }}"
                          data-skipped='{{ row["skipped_invoices"] | tojson }}'>
                    Skipped
                  </button>
                {% endif %}
                {% if row['short_paid_count'] > 0 %}
                  <button type="button" class="short-paid short-paid-btn {% if row['sent_short_paid'] %}sent{% endif %}"
                          data-recipient-id="{{ row['recipient_id'] }}"
                          data-run-id="{{ run['id'] if run else '' }}"
                          data-has-email="{{ '1' if row['has_email'] else '0' }}"
                          data-group-name="{{ row['group_name'] }}"
                          data-short-paid='{{ row["short_paid_invoices"] | tojson }}'>
                    Short Paid
                  </button>
                {% endif %}
              {% else %}
                <small>Missing recipient</small>
              {% endif %}
            </td>
          </tr>
        {% else %}
          <tr><td colspan="9">No overdue, skipped, or short-paid groups found.</td></tr>
        {% endfor %}
      </tbody>
      <tfoot>
        <tr>
          <th colspan="2">Totals</th>
          <th>{{ total_overdue_count }}</th>
          <th>-</th>
          <th>${{ "{:,.2f}".format(total_overdue_amount) }}</th>
          <th>{{ total_short_paid_count }}</th>
          <th>${{ "{:,.2f}".format(total_short_paid_amount) }}</th>
          <th></th>
          <th></th>
        </tr>
      </tfoot>
    </table>
    <p><small>Note: Bill to Bill groups use the next invoice ship date as the due date for prior invoices.</small></p>
  </div>

  <div id="skippedModal" class="modal">
    <div class="modal-card">
      <h3>Send Skipped Notice</h3>
      <form id="skippedForm" method="post" enctype="multipart/form-data">
        <input type="hidden" name="run_id" id="skippedRunId" value="" />
        <input type="hidden" name="email_to" id="skippedEmailTo" value="" />
        <div id="skippedFiles"></div>
        <div class="actions">
          <button type="submit" class="skipped">Send Skipped Notice</button>
          <button type="button" class="secondary" id="skippedCancel">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <div id="shortPaidModal" class="modal">
    <div class="modal-card">
      <h3>Send Short Paid Notice</h3>
      <form id="shortPaidForm" method="post" enctype="multipart/form-data">
        <input type="hidden" name="run_id" id="shortPaidRunId" value="" />
        <input type="hidden" name="email_to" id="shortPaidEmailTo" value="" />
        <div id="shortPaidFiles"></div>
        <div class="actions">
          <button type="submit" class="short-paid">Send Short Paid Notice</button>
          <button type="button" class="secondary" id="shortPaidCancel">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <div id="missingEmailModal" class="modal">
    <div class="modal-card">
      <h3>Add Email To Continue</h3>
      <p><small id="missingEmailLabel"></small></p>
      <div class="row">
        <div>
          <label>Emails (comma separated)</label>
          <input id="missingEmailInput" placeholder="name@company.com, team@company.com" />
        </div>
      </div>
      <div class="actions">
        <button type="button" id="missingEmailSave">Save & Continue</button>
        <button type="button" class="secondary" id="missingEmailCancel">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    const skippedModal = document.getElementById('skippedModal');
    const skippedForm = document.getElementById('skippedForm');
    const skippedFiles = document.getElementById('skippedFiles');
    const skippedRunId = document.getElementById('skippedRunId');
    const skippedCancel = document.getElementById('skippedCancel');

    const shortPaidModal = document.getElementById('shortPaidModal');
    const shortPaidForm = document.getElementById('shortPaidForm');
    const shortPaidFiles = document.getElementById('shortPaidFiles');
    const shortPaidRunId = document.getElementById('shortPaidRunId');
    const skippedEmailTo = document.getElementById('skippedEmailTo');
    const shortPaidEmailTo = document.getElementById('shortPaidEmailTo');
    const shortPaidCancel = document.getElementById('shortPaidCancel');

    const missingEmailModal = document.getElementById('missingEmailModal');
    const missingEmailLabel = document.getElementById('missingEmailLabel');
    const missingEmailInput = document.getElementById('missingEmailInput');
    const missingEmailSave = document.getElementById('missingEmailSave');
    const missingEmailCancel = document.getElementById('missingEmailCancel');

    let onMissingEmailContinue = null;

    function closeMissingEmailModal() {
      missingEmailModal.classList.remove('active');
      missingEmailInput.value = '';
      onMissingEmailContinue = null;
    }

    async function persistRecipientEmail(recipientId, emailValue) {
      const payload = new URLSearchParams();
      payload.set('email_to', emailValue);
      const response = await fetch(`/customers/${recipientId}/emails`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: payload.toString(),
      });
      const result = await response.json().catch(() => ({}));
      if (!response.ok || !result.ok) {
        throw new Error(result.error || 'Unable to save email.');
      }
    }

    function openMissingEmailModal(recipientId, groupName, callback) {
      onMissingEmailContinue = { recipientId, callback };
      missingEmailLabel.textContent = `Recipient: ${groupName || 'Selected customer'}`;
      missingEmailInput.value = '';
      missingEmailModal.classList.add('active');
    }

    function openSkippedModal(button) {
      const recipientId = button.dataset.recipientId;
      const runId = button.dataset.runId || '';
      const skipped = JSON.parse(button.dataset.skipped || '[]');

      skippedForm.action = `/overdue-report/skipped/${recipientId}`;
      skippedRunId.value = runId;
      skippedFiles.innerHTML = '';

      skipped.forEach((inv, idx) => {
        const wrapper = document.createElement('div');
        const label = document.createElement('label');
        const orderId = inv.order_id || `Invoice ${idx + 1}`;
        const shipDate = inv.ship_date ? ` (Ship ${inv.ship_date})` : '';
        const location = inv.location ? ` - ${inv.location}` : '';
        label.textContent = `${orderId}${shipDate}${location}`;
        const copyBtn = document.createElement('button');
        copyBtn.type = 'button';
        copyBtn.className = 'copy-btn';
        copyBtn.textContent = 'Copy #';
        copyBtn.addEventListener('click', () => {
          navigator.clipboard.writeText(orderId);
          copyBtn.textContent = 'Copied';
          setTimeout(() => (copyBtn.textContent = 'Copy #'), 1200);
        });
        const input = document.createElement('input');
        input.type = 'file';
        input.name = 'invoice_files';
        input.accept = '.pdf';
        input.required = true;
        const hidden = document.createElement('input');
        hidden.type = 'hidden';
        hidden.name = 'invoice_ids';
        hidden.value = orderId;

        wrapper.appendChild(label);
        wrapper.appendChild(copyBtn);
        wrapper.appendChild(input);
        wrapper.appendChild(hidden);
        skippedFiles.appendChild(wrapper);
      });

      skippedModal.classList.add('active');
    }

    function openShortPaidModal(button) {
      const recipientId = button.dataset.recipientId;
      const runId = button.dataset.runId || '';
      const shortPaid = JSON.parse(button.dataset.shortPaid || '[]');

      shortPaidForm.action = `/overdue-report/short-paid/${recipientId}`;
      shortPaidRunId.value = runId;
      shortPaidFiles.innerHTML = '';

      shortPaid.forEach((inv, idx) => {
        const wrapper = document.createElement('div');
        const label = document.createElement('label');
        const orderId = inv.order_id || `Invoice ${idx + 1}`;
        const shipDate = inv.ship_date ? ` (Ship ${inv.ship_date})` : '';
        const location = inv.location ? ` - ${inv.location}` : '';
        label.textContent = `${orderId}${shipDate}${location}`;
        const copyBtn = document.createElement('button');
        copyBtn.type = 'button';
        copyBtn.className = 'copy-btn';
        copyBtn.textContent = 'Copy #';
        copyBtn.addEventListener('click', () => {
          navigator.clipboard.writeText(orderId);
          copyBtn.textContent = 'Copied';
          setTimeout(() => (copyBtn.textContent = 'Copy #'), 1200);
        });
        const input = document.createElement('input');
        input.type = 'file';
        input.name = 'invoice_files';
        input.accept = '.pdf';
        input.required = true;
        const hidden = document.createElement('input');
        hidden.type = 'hidden';
        hidden.name = 'invoice_ids';
        hidden.value = orderId;

        wrapper.appendChild(label);
        wrapper.appendChild(copyBtn);
        wrapper.appendChild(input);
        wrapper.appendChild(hidden);
        shortPaidFiles.appendChild(wrapper);
      });

      shortPaidModal.classList.add('active');
    }

    function withRecipientEmail(button, callback) {
      if (button.dataset.hasEmail === '1') {
        callback('');
        return;
      }
      openMissingEmailModal(button.dataset.recipientId, button.dataset.groupName, (emailValue) => {
        button.dataset.hasEmail = '1';
        callback(emailValue);
      });
    }

    document.querySelectorAll('.overdue-form').forEach((form) => {
      form.addEventListener('submit', (event) => {
        if (form.dataset.hasEmail === '1') {
          return;
        }
        event.preventDefault();
        openMissingEmailModal(form.dataset.recipientId, form.dataset.groupName, (emailValue) => {
          form.dataset.hasEmail = '1';
          const input = form.querySelector('.email-override-input');
          if (input) {
            input.value = emailValue;
          }
          form.submit();
        });
      });
    });

    document.querySelectorAll('.skipped-btn').forEach((btn) => {
      btn.addEventListener('click', () => {
        withRecipientEmail(btn, (emailValue) => {
          skippedEmailTo.value = emailValue || '';
          openSkippedModal(btn);
        });
      });
    });

    document.querySelectorAll('.short-paid-btn').forEach((btn) => {
      btn.addEventListener('click', () => {
        withRecipientEmail(btn, (emailValue) => {
          shortPaidEmailTo.value = emailValue || '';
          openShortPaidModal(btn);
        });
      });
    });

    skippedCancel.addEventListener('click', () => {
      skippedModal.classList.remove('active');
      skippedForm.action = '';
      skippedFiles.innerHTML = '';
      skippedEmailTo.value = '';
    });

    skippedModal.addEventListener('click', (event) => {
      if (event.target === skippedModal) {
        skippedModal.classList.remove('active');
        skippedForm.action = '';
        skippedFiles.innerHTML = '';
        skippedEmailTo.value = '';
      }
    });

    shortPaidCancel.addEventListener('click', () => {
      shortPaidModal.classList.remove('active');
      shortPaidForm.action = '';
      shortPaidFiles.innerHTML = '';
      shortPaidEmailTo.value = '';
    });

    shortPaidModal.addEventListener('click', (event) => {
      if (event.target === shortPaidModal) {
        shortPaidModal.classList.remove('active');
        shortPaidForm.action = '';
        shortPaidFiles.innerHTML = '';
        shortPaidEmailTo.value = '';
      }
    });

    missingEmailSave.addEventListener('click', async () => {
      const value = (missingEmailInput.value || '').trim();
      if (!value) {
        alert('Please add one or more email addresses.');
        return;
      }
      const payload = onMissingEmailContinue;
      if (!payload || !payload.recipientId || !payload.callback) {
        closeMissingEmailModal();
        return;
      }
      missingEmailSave.disabled = true;
      try {
        await persistRecipientEmail(payload.recipientId, value);
        closeMissingEmailModal();
        payload.callback(value);
      } catch (err) {
        alert(err.message || 'Unable to save email.');
      } finally {
        missingEmailSave.disabled = false;
      }
    });

    missingEmailCancel.addEventListener('click', closeMissingEmailModal);
    missingEmailModal.addEventListener('click', (event) => {
      if (event.target === missingEmailModal) {
        closeMissingEmailModal();
      }
    });

    const overdueSearch = document.getElementById('overdueSearch');
    const overdueTerms = document.getElementById('overdueTerms');
    const overdueTable = document.querySelector('table.table');
    const overdueTbody = overdueTable.querySelector('tbody');
    const sortableHeaders = overdueTable.querySelectorAll('th.sortable');
    let sortKey = '';
    let sortDirection = 'asc';

    function getOverdueRows() {
      return Array.from(overdueTbody.querySelectorAll('tr[data-search]'));
    }

    function parseNumber(value) {
      const parsed = Number(String(value || '').replace(/[^0-9.-]/g, ''));
      return Number.isFinite(parsed) ? parsed : 0;
    }

    function getSortValue(row, key) {
      const cells = row.cells;
      if (key === 'group_name') return (cells[0]?.textContent || '').trim().toLowerCase();
      if (key === 'terms') return (cells[1]?.textContent || '').trim().toLowerCase();
      if (key === 'overdue_count') return parseNumber(cells[2]?.textContent);
      if (key === 'days_overdue') return parseNumber(cells[3]?.textContent);
      if (key === 'overdue_amount') return parseNumber(cells[4]?.textContent);
      if (key === 'short_paid_count') return parseNumber(cells[5]?.textContent);
      if (key === 'short_paid_amount') return parseNumber(cells[6]?.textContent);
      if (key === 'skipped_count') return parseNumber(cells[7]?.textContent);
      return '';
    }

    function applyOverdueSort() {
      if (!sortKey) {
        return;
      }
      const rows = getOverdueRows();
      rows.sort((a, b) => {
        const aValue = getSortValue(a, sortKey);
        const bValue = getSortValue(b, sortKey);

        let base = 0;
        if (typeof aValue === 'number' && typeof bValue === 'number') {
          base = aValue - bValue;
        } else {
          base = String(aValue).localeCompare(String(bValue), undefined, { sensitivity: 'base' });
        }
        return sortDirection === 'asc' ? base : -base;
      });
      rows.forEach((row) => overdueTbody.appendChild(row));
    }

    function refreshSortIndicators() {
      sortableHeaders.forEach((header) => {
        const key = header.dataset.sortKey || '';
        header.classList.remove('asc', 'desc');
        header.removeAttribute('aria-sort');
        if (key === sortKey) {
          header.classList.add(sortDirection);
          header.setAttribute('aria-sort', sortDirection === 'asc' ? 'ascending' : 'descending');
        }
      });
    }

    function filterOverdue() {
      const query = (overdueSearch.value || '').toLowerCase();
      const terms = overdueTerms.value;
      getOverdueRows().forEach((row) => {
        const matchesText = row.dataset.search.includes(query);
        const matchesTerms = !terms || row.dataset.terms === terms;
        row.style.display = matchesText && matchesTerms ? '' : 'none';
      });
    }

    sortableHeaders.forEach((header) => {
      header.addEventListener('click', () => {
        const clickedKey = header.dataset.sortKey || '';
        if (!clickedKey) {
          return;
        }
        if (sortKey === clickedKey) {
          sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
          sortKey = clickedKey;
          sortDirection = 'asc';
        }
        applyOverdueSort();
        filterOverdue();
        refreshSortIndicators();
      });
    });

    overdueSearch.addEventListener('input', filterOverdue);
    overdueTerms.addEventListener('change', filterOverdue);
    sortKey = 'overdue_amount';
    sortDirection = 'desc';
    applyOverdueSort();
    refreshSortIndicators();
    filterOverdue();
  </script>
{% endblock %}
