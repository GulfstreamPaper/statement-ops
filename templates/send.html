{% extends "base.html" %}
{% block content %}
  <div class="panel">
    <h2>Send Statement Now</h2>
    <form method="post" id="sendNowForm">
      <div class="row">
        <div>
          <label>Customer or Group</label>
          <input id="selectedRecipientName" placeholder="Select customer or group" readonly />
          <input type="hidden" name="recipient_id" id="selectedRecipientId" />
          <input type="hidden" name="email_to" id="sendEmailOverride" />
          <button type="button" class="secondary" id="openRecipientPicker">Select</button>
        </div>
        <div>
          <label>Invoice File (optional)</label>
          <select name="invoice_file_id">
            <option value="">Use default (latest upload or path)</option>
            {% for f in invoice_files %}
              <option value="{{ f['id'] }}">{{ f['filename'] }} - {{ f['uploaded_at'] }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div class="actions">
        <button type="submit" name="action" value="send">Send Statement</button>
        <button type="button" class="secondary" id="downloadStatement">Download Statement</button>
      </div>
    </form>
  </div>

  <div class="modal" id="recipientPickerModal">
    <div class="modal-card">
      <h3>Select Recipient</h3>
      <div class="tabs">
        <button class="tab active" type="button" data-tab="picker-groups">Groups</button>
        <button class="tab" type="button" data-tab="picker-singles">Single</button>
      </div>

      <div class="tab-panel active" id="picker-groups">
        <div class="row">
          <div>
            <label>Search</label>
            <input id="groupPickerSearch" placeholder="Search groups" />
          </div>
        </div>
        <div class="picker-list">
          {% for g in groups %}
            <div class="picker-item" data-id="{{ g['id'] }}" data-name="{{ g['group_name'] }}" data-search="{{ g['group_name'] | lower }}" data-has-email="{{ '1' if (g['email_to'] or '').strip() else '0' }}">
              {{ g['group_name'] }}
            </div>
          {% else %}
            <p><small>No groups yet.</small></p>
          {% endfor %}
        </div>
      </div>

      <div class="tab-panel" id="picker-singles">
        <div class="row">
          <div>
            <label>Search</label>
            <input id="singlePickerSearch" placeholder="Search customers" />
          </div>
        </div>
        <div class="picker-list">
          {% for s in singles %}
            <div class="picker-item" data-id="{{ s['id'] }}" data-name="{{ s['group_name'] }}" data-search="{{ s['group_name'] | lower }}" data-has-email="{{ '1' if (s['email_to'] or '').strip() else '0' }}">
              {{ s['group_name'] }}
            </div>
          {% else %}
            <p><small>No customers yet.</small></p>
          {% endfor %}
        </div>
      </div>

      <div class="actions">
        <button type="button" class="secondary" id="closeRecipientPicker">Close</button>
      </div>
    </div>
  </div>

  <div class="modal" id="sendMissingEmailModal">
    <div class="modal-card">
      <h3>Add Email To Continue</h3>
      <p><small id="sendMissingEmailLabel"></small></p>
      <div class="row">
        <div>
          <label>Emails (comma separated)</label>
          <input id="sendMissingEmailInput" placeholder="name@company.com, team@company.com" />
        </div>
      </div>
      <div class="actions">
        <button type="button" id="sendMissingEmailSave">Save & Continue</button>
        <button type="button" class="secondary" id="sendMissingEmailCancel">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    const pickerModal = document.getElementById('recipientPickerModal');
    const openPicker = document.getElementById('openRecipientPicker');
    const closePicker = document.getElementById('closeRecipientPicker');
    const selectedName = document.getElementById('selectedRecipientName');
    const selectedId = document.getElementById('selectedRecipientId');
    const sendNowForm = document.getElementById('sendNowForm');
    const sendEmailOverride = document.getElementById('sendEmailOverride');
    const sendMissingEmailModal = document.getElementById('sendMissingEmailModal');
    const sendMissingEmailLabel = document.getElementById('sendMissingEmailLabel');
    const sendMissingEmailInput = document.getElementById('sendMissingEmailInput');
    const sendMissingEmailSave = document.getElementById('sendMissingEmailSave');
    const sendMissingEmailCancel = document.getElementById('sendMissingEmailCancel');
    let selectedHasEmail = true;

    if (openPicker) {
      openPicker.addEventListener('click', () => {
        pickerModal.classList.add('active');
      });
    }
    if (closePicker) {
      closePicker.addEventListener('click', () => {
        pickerModal.classList.remove('active');
      });
    }

    const pickerTabs = pickerModal.querySelectorAll('.tab');
    const pickerPanels = pickerModal.querySelectorAll('.tab-panel');
    pickerTabs.forEach((tab) => {
      tab.addEventListener('click', () => {
        pickerTabs.forEach((btn) => btn.classList.remove('active'));
        pickerPanels.forEach((panel) => panel.classList.remove('active'));
        tab.classList.add('active');
        const target = document.getElementById(tab.dataset.tab);
        if (target) target.classList.add('active');
      });
    });

    function bindPickerSearch(inputId, listSelector) {
      const input = document.getElementById(inputId);
      const items = document.querySelectorAll(listSelector);
      if (!input) return;
      input.addEventListener('input', () => {
        const query = (input.value || '').toLowerCase();
        items.forEach((item) => {
          item.style.display = item.dataset.search.includes(query) ? '' : 'none';
        });
      });
    }
    bindPickerSearch('groupPickerSearch', '#picker-groups .picker-item');
    bindPickerSearch('singlePickerSearch', '#picker-singles .picker-item');

    document.querySelectorAll('.picker-item').forEach((item) => {
      item.addEventListener('click', () => {
        selectedName.value = item.dataset.name;
        selectedId.value = item.dataset.id;
        selectedHasEmail = item.dataset.hasEmail === '1';
        sendEmailOverride.value = '';
        pickerModal.classList.remove('active');
      });
    });

    function closeSendMissingEmailModal() {
      sendMissingEmailModal.classList.remove('active');
      sendMissingEmailInput.value = '';
    }

    async function persistRecipientEmail(recipientId, emailValue) {
      const payload = new URLSearchParams();
      payload.set('email_to', emailValue);
      const response = await fetch(`/customers/${recipientId}/emails`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: payload.toString(),
      });
      const result = await response.json().catch(() => ({}));
      if (!response.ok || !result.ok) {
        throw new Error(result.error || 'Unable to save email.');
      }
    }

    if (sendMissingEmailCancel) {
      sendMissingEmailCancel.addEventListener('click', closeSendMissingEmailModal);
    }

    if (sendMissingEmailModal) {
      sendMissingEmailModal.addEventListener('click', (event) => {
        if (event.target === sendMissingEmailModal) {
          closeSendMissingEmailModal();
        }
      });
    }

    if (sendNowForm) {
      sendNowForm.addEventListener('submit', (event) => {
        if (!selectedId.value || selectedHasEmail) {
          return;
        }
        event.preventDefault();
        sendMissingEmailLabel.textContent = `Recipient: ${selectedName.value || 'Selected customer'}`;
        sendMissingEmailModal.classList.add('active');
      });
    }

    if (sendMissingEmailSave) {
      sendMissingEmailSave.addEventListener('click', async () => {
        const value = (sendMissingEmailInput.value || '').trim();
        if (!value) {
          alert('Please add one or more email addresses.');
          return;
        }
        if (!selectedId.value) {
          alert('Please select a customer or group first.');
          return;
        }
        sendMissingEmailSave.disabled = true;
        try {
          await persistRecipientEmail(selectedId.value, value);
          sendEmailOverride.value = value;
          selectedHasEmail = true;
          closeSendMissingEmailModal();
          sendNowForm.submit();
        } catch (err) {
          alert(err.message || 'Unable to save email.');
        } finally {
          sendMissingEmailSave.disabled = false;
        }
      });
    }

    const downloadBtn = document.getElementById('downloadStatement');
    const invoiceSelect = document.querySelector('select[name="invoice_file_id"]');
    const downloadUrl = "{{ url_for('send_download') }}";

    if (downloadBtn) {
      downloadBtn.addEventListener('click', () => {
        if (!selectedId.value) {
          alert('Please select a customer or group first.');
          return;
        }
        const params = new URLSearchParams();
        params.set('recipient_id', selectedId.value);
        if (invoiceSelect && invoiceSelect.value) {
          params.set('invoice_file_id', invoiceSelect.value);
        }
        window.open(`${downloadUrl}?${params.toString()}`, '_blank');
      });
    }
  </script>
{% endblock %}
